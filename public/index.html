<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./styles/home.css" />
    <link rel="shortcut icon" href="icon.ico" type="image/x-icon" />

    <title>Dashboard - ANFeGuard</title>
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body>
    <div class="sidebar">
      <h2 class="logo">ANFeGuard</h2>
      <nav>
        <a href="/index.html" class="active">Dashboard</a>
        <a href="/servico.html">Serviços</a>
        <a href="/cadastro.html">Controle de Portas</a>
        <a href="/logs.html">Logs</a>
      </nav>
    </div>

    <div class="main-content">
      <header>
        <h1>Monitoramento de Recursos</h1>
      </header>

      <section
        class="charts"
        hx-get="/api/metrics"
        hx-trigger="load, every 5s"
        hx-target="#charts-data"
        hx-swap="none"
      >
        <div id="charts-data">
          <div class="chart-card">
            <h3>CPU (%)</h3>
            <canvas id="cpuChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Memória (%)</h3>
            <canvas id="memChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Disco (%)</h3>
            <canvas id="diskChart"></canvas>
          </div>
        </div>
      </section>
    </div>

    <script>
      // Gráficos são criados uma única vez
      const cpuCtx = document.getElementById("cpuChart").getContext("2d");
      const memCtx = document.getElementById("memChart").getContext("2d");
      const diskCtx = document.getElementById("diskChart").getContext("2d");

      const makeChart = (ctx, label, color) =>
        new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label,
                data: [],
                borderColor: color,
                backgroundColor: color + "33",
                tension: 0.3,
                fill: true,
              },
            ],
          },
          options: {
            animation: true,
            scales: { y: { min: 0, max: 100 } },
            plugins: { legend: { display: false } },
          },
        });

      const cpuChart = makeChart(cpuCtx, "CPU", "#007bff");
      const memChart = makeChart(memCtx, "Memória", "#28a745");
      const diskChart = makeChart(diskCtx, "Disco", "#dc3545");

      function addPoint(chart, value) {
        const now = new Date().toLocaleTimeString();
        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(value);
        if (chart.data.labels.length > 15) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }
        chart.update();
      }

      document.body.addEventListener("htmx:afterSwap", (evt) => {
        if (evt.detail.target.id === "charts-data") {
          const metrics = evt.detail.xhr.response
            ? JSON.parse(evt.detail.xhr.response)
            : null;
          if (metrics) {
            addPoint(cpuChart, metrics.cpu_percent);
            addPoint(memChart, metrics.memory_percent);
            addPoint(diskChart, metrics.disk_used_percent);
          }
        }
      });
    </script>
  </body>
</html>
